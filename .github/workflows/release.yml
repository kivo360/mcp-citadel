name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: mcp-citadel-macos-arm64
          - os: macos-13
            target: x86_64-apple-darwin
            artifact_name: mcp-citadel-macos-x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: mcp-citadel-linux-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}

      - name: Build release binaries
        run: |
          cargo build --release --bins --target ${{ matrix.target }}

      - name: Create tarball
        run: |
          cd target/${{ matrix.target }}/release
          tar -czf ../../../${{ matrix.artifact_name }}.tar.gz mcp-citadel mcp-client
          cd ../../..

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact_name }}.tar.gz
          body: |
            ## ðŸŽ‰ MCP Citadel Release ${{ github.ref_name }}

            ### ðŸš€ Key Features
            - **67% memory reduction** (3.6GB saved)
            - **10x faster startup** - servers already running
            - **Zero config changes** to MCP messages
            - **Production-ready** Rust implementation

            ### ðŸ“¦ Installation

            #### macOS (ARM64/Apple Silicon)
            ```bash
            curl -L https://github.com/kivo360/mcp-citadel/releases/download/${{ github.ref_name }}/mcp-citadel-macos-arm64.tar.gz | tar xz
            sudo mv mcp-citadel mcp-client /usr/local/bin/
            ```

            #### macOS (x64/Intel)
            ```bash
            curl -L https://github.com/kivo360/mcp-citadel/releases/download/${{ github.ref_name }}/mcp-citadel-macos-x64.tar.gz | tar xz
            sudo mv mcp-citadel mcp-client /usr/local/bin/
            ```

            #### Linux (x64)
            ```bash
            curl -L https://github.com/kivo360/mcp-citadel/releases/download/${{ github.ref_name }}/mcp-citadel-linux-x64.tar.gz | tar xz
            sudo mv mcp-citadel mcp-client /usr/local/bin/
            ```

            ### ðŸ“š Documentation
            - [Production Guide](https://github.com/kivo360/mcp-citadel/blob/master/PRODUCTION.md)
            - [Robustness Features](https://github.com/kivo360/mcp-citadel/blob/master/ROBUSTNESS.md)
            - [Full Changelog](https://github.com/kivo360/mcp-citadel/blob/master/CHANGELOG.md)

            **Built with** ðŸ¦€ Rust
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
